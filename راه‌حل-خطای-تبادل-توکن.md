# راهنمای رفع خطای "Client not allowed to exchange"

## توضیح خطا

خطایی که با آن مواجه شده‌اید به این معناست:

```
error: 'access_denied',
error_description: 'Client not allowed to exchange'
```

این خطا نشان می‌دهد که کلاینت Keycloak شما (`api-um`) اجازه تبادل توکن (Token Exchange) را ندارد. تبادل توکن یک قابلیت امنیتی در Keycloak است که باید به صورت صریح برای کلاینت فعال شود.

## راه حل مشکل

برای حل این مشکل، شما باید تنظیمات کلاینت خود را در پنل مدیریتی Keycloak به‌روزرسانی کنید:

### گام ۱: ورود به پنل مدیریتی Keycloak

1. به آدرس Keycloak که در متغیر `KEYCLOAK_HOST` تعریف شده مراجعه کنید (در مثال شما: `https://agbk-auth.darkube.app`)
2. وارد پنل مدیریتی شوید
3. به ریلم مورد نظر خود بروید (در مثال شما: `nest-1`)

### گام ۲: پیکربندی کلاینت

1. در منوی سمت چپ، روی "Clients" کلیک کنید
2. کلاینت مورد نظر خود را پیدا کنید (در مثال شما: `api-um`)
3. روی نام کلاینت کلیک کنید تا تنظیمات آن باز شود

### گام ۳: فعال‌سازی قابلیت تبادل توکن

#### در Keycloak نسخه ۱۷ و بالاتر:

1. به تب "Advanced" بروید
2. گزینه "OAuth 2.0 Device Authorization Grant Enabled" را فعال کنید
3. گزینه "Token Exchange" را فعال کنید
4. روی دکمه "Save" کلیک کنید

#### در Keycloak نسخه قدیمی‌تر:

1. به تب "Permissions" بروید
2. گزینه "Service Account Roles" را فعال کنید
3. روی دکمه "Save" کلیک کنید

### گام ۴: تنظیم سیاست‌های تبادل توکن (برای نسخه‌های جدیدتر)

1. به تب "Client Scopes" بروید
2. روی "token-exchange" یا اسکوپی با نام مشابه کلیک کنید
3. اطمینان حاصل کنید که این اسکوپ به کلاینت شما اضافه شده است

### گام ۵: تنظیم نقش‌های سرویس (Service Account Roles)

1. روی تب "Service Account Roles" کلیک کنید
2. در بخش "Client Roles"، از منوی کشویی "realm-management" را انتخاب کنید
3. نقش "token-exchange" یا "manage-clients" را از لیست سمت چپ انتخاب کرده و روی "Add selected" کلیک کنید

### گام ۶: اطمینان از وجود Issuer در Fine Grain Permissions

1. در تنظیمات کلاینت، به تب "Authorization" بروید
2. اطمینان حاصل کنید که "Authorization Enabled" فعال است
3. سپس روی "Authorization Scopes" کلیک کنید
4. اضافه کردن اسکوپ جدید با نام `subject_issuer:google`

## نکات تکمیلی

1. **بررسی متغیرهای محیطی**: اطمینان حاصل کنید که متغیرهای محیطی زیر به درستی تنظیم شده‌اند:

   - `KEYCLOAK_HOST`
   - `KEYCLOAK_REALM`
   - `KEYCLOAK_CLIENT_ID`
   - `KEYCLOAK_SECRET`

2. **Identity Provider**: اطمینان حاصل کنید که Identity Provider گوگل در Keycloak به درستی پیکربندی شده است:

   - به بخش "Identity Providers" در منوی اصلی بروید
   - "Google" را انتخاب یا اضافه کنید
   - اطمینان حاصل کنید که Client ID و Client Secret گوگل به درستی وارد شده‌اند

3. **محدودیت‌های مرورگر**: در صورت استفاده از احراز هویت گوگل، اطمینان حاصل کنید که Redirect URI در تنظیمات گوگل و Keycloak یکسان است

## تست راه‌حل

پس از انجام تغییرات بالا، اپلیکیشن خود را دوباره اجرا کنید و مجدداً احراز هویت گوگل را تست کنید.

اگر خطا همچنان وجود دارد، لاگ کامل خطا را بررسی کنید تا جزئیات بیشتری به دست آورید:

```javascript
console.log(
  'Token exchange request complete response:',
  JSON.stringify(data, null, 2),
);
```

این خط را قبل از بررسی خطا در متد `googleAuth` اضافه کنید تا پاسخ کامل را ببینید.
